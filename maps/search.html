<!DOCTYPE html>
<html lang='en-us'>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="BarbellFinder is an easy way to find your next gym. Search hundreds of gym listings.">
    <meta name="msvalidate.01" content="C036FD7FE6F9C4782FAC3CC31A8EBEFB" />
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
    <link rel="manifest" href="./site.webmanifest">
    <title>Fast and Easy Gym Search | BarbellFinder</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBWUIVQ6XyFm2qpZwJD1OY2rdJ1BOKw9lE&callback=initMap&libraries=&v=weekly"
      defer
    ></script>
    <style type="text/css">
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
        width: 100%;
      }

      #side {
          width: 400px;
      }

      @media screen and (min-device-width: 575px) {
          #side {
            overflow-y: scroll;
          }
      }

      #content {
        display: flex;
        height: calc(100% - 64px);
      }

      @media only screen 
        and (max-device-width: 575px) { 
        #content {
            flex-direction: column;
        }
      }

      /* Optional: Makes the sample page fill the window. */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #floating-panel {
        position: absolute;
        top: 75px;
        left: 50%;
        z-index: 5;
        text-align: center;
        font-family: "Roboto", "sans-serif";
        line-height: 30px;
      }

      @media only screen 
        and (max-device-width: 575px) { 
        #floating-panel {
            top: 300px;
            left: 5px;
        }
      }
    </style>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-38QF05WV91"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-38QF05WV91');
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand-sm navbar-expand-md navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="./images/bbfIcon30x30.png" alt="icon" height="30" width="30">
                BarbellFinder
            </a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link" href="./index.html">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="./owners.html">Owners</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="./register.html">Add your gym</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="./blog/">Blog</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="./skipTheSearch.html">Skip the search</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="./contact.html">Contact Us</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <div id="floating-panel">
        <input id="address" type="textbox" value="Chicago, IL" />
        <input id="submit" type="button" value="Search" />
      </div>
      <div id="content">
          <div id="side" class="">
              <div class="container">
                  <div class="row">
                    <div class="col-12">
                        <h1 class="h2">Searching gyms near Chicago, IL</h1>
                        <div id="gymsShown"></div>
                        <hr />
                        <h3>Filters</h3>
                        <h5>Classes</h5>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="yogaCheck" onclick="updateClassesOnClick('yoga')">
                            <label class="form-check-label" for="yogaCheck">Yoga</label>
                        </div>
                        <div id="389421707">
                            <script type="text/javascript">
                            if (document.location.origin != 'file://') {
                                try {
                                    window._mNHandle.queue.push(function (){
                                        window._mNDetails.loadTag("389421707", "300x250", "389421707");
                                    });
                                }
                                catch (error) {}
                            }
                            </script>
                        </div>
                    </div>
                  </div>
              </div>
          </div>
          <div id="map"></div>
      </div>
      <script>
        let map;
        let markers = [];
        const urlParams = new URLSearchParams(window.location.search);
        let apiGyms = [];
                
        updatePageValuesWithSearchQuery();
        
        document.getElementById("submit").addEventListener("click", () => {                       
            // Update url with search query
            let address = document.getElementById('address').value;

            urlParams.set('search', address);
            document.location = `${location.pathname}?${urlParams.toString()}`;
        });
        
        /* Functions */
        function updatePageValuesWithSearchQuery() {           
            const query = urlParams.get('search') || 'Chicago, IL';
            const classes = urlParams.get('classes');
            
            // Search Value
            document.getElementById('address').value = query;
            document.querySelector('title').innerHTML = `Gyms near ${query} | BarbellFinder`;
            document.querySelector('#side h1').innerHTML = `Searching gyms near ${query}`;

            // Classes Value
            classes && classes.split(',').forEach(function(element) {
                document.querySelector(`#${element}Check`).checked = true;
            });
        }

        function removeElementFromArray(array, element) {
            console.log('array', array);

            if (array.lastIndexOf(element) != -1) {
                const index = array.lastIndexOf(element);
                array.splice(index, 1);

                return array;
            } else {
                return array;
            }
        }

        function updateClassesOnClick(classType) {
            const isChecked = document.querySelector(`#${classType}Check`).checked;
            const classes = urlParams.get('classes');

            if (isChecked) {
                // Add value
                if (classes && classes.includes(classType)) {
                    // Do Nothing
                } else {
                    console.log('Classes', classes);
                    if (classes == '' || classes == null) {
                        urlParams.set('classes', classType);
                    } else {
                        urlParams.set('classes', `,${classType}`);
                    } 
                    document.location = `${location.pathname}?${urlParams.toString()}`;                  
                }
            } else {
                // Remove value
                if (classes == '') {
                    // Do Nothing
                } else {
                    if (classes && classes.includes(classType)) {
                        let array = classes.split(',');
                        let newArray = removeElementFromArray(array, classType);
                        console.log('New Array', newArray);
                        urlParams.set('classes', newArray.toString());
                        document.location = `${location.pathname}?${urlParams.toString()}`;
                    } else {
                        // Do Nothing
                    }
                }
            }

            
        }

        function hasAmenities(gym) {
            const amenities = urlParams.get('amenities');
            // if amenities does not exist or is empty
            if (amenities == null || amenities == '') {
                return true;
            }

            function hasAmenity(amenity) {
                // console.log('Amenity', amenity)
                if (gym && gym[amenity] == 1) {
                    return true;
                }

                return false;
            }
            
            // console.log('amenities', amenities);
            return amenities.split(',').every(hasAmenity);
        }

        function hasClasses(gym) {
            const classes = urlParams.get('classes');
            // if classes does not exist or is empty
            if (classes == null || classes == '') {
                return true;
            }

            function hasClass(classType) {
                // console.log('Class', classType);
                if (gym && gym[classType] == 1) {
                    return true;
                }

                return false;
            }
            
            // console.log('amenities', amenities);
            return classes.split(',').every(hasClass);
        }

        function initMap() {
          const myLatLng = { lat: 41.8781, lng: -87.6298 };
          const geocoder = new google.maps.Geocoder();

          map = new google.maps.Map(document.getElementById("map"), {
            zoom: 12,
            center: myLatLng,
            fullscreenControl: false,
            mapTypeControl: false,
            streetViewControl: false,
          });

          google.maps.event.addListener(map, 'bounds_changed', function() {
            const bounds =  map.getBounds();

            getGymsFromApi(bounds.getSouthWest(), bounds.getNorthEast());
          });
  
          geocodeAddress(geocoder, map); 
        }

        function geocodeAddress(geocoder, resultsMap) {
            let address = document.getElementById('address').value;
          
            geocoder.geocode({ address: address }, (results, status) => {
                if (status === "OK") {
                resultsMap.setCenter(results[0].geometry.location);                
                
                // Log out the lat long coordinate
                console.log({"lat": results[0].geometry.location.lat(), "lng": results[0].geometry.location.lng()});
                } else {
                alert(
                    "Geocode was not successful for the following reason: " + status
                );
                }
            });
        }
  
        // Adds a marker to the map and push to the array.
        function addMarker(gym) {
            const checkmark = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16">' +
  '<path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>' +
"</svg>";
          const gymPhoneNumber = gym?.phone ? `<p>${gym.phone}</p>` : '';
          const detailsLink = `<p><a href="./details.html?lat=${gym.lat}&lng=${gym.lng}">View Details ></a></p>`;

          // Classes
        const boxing = gym?.boxing != 0 ? `<div class="col">${checkmark}<br />Boxing</div>` : '';
        const yoga = gym?.yoga != 0 ? `<div class="col">${checkmark}<br />Yoga</div>` : '';
        const bootcamp = gym?.bootcamp != 0 ? `<div class="col">${checkmark}<br />Boot Camp</div>` : '';
        const crossfit = gym?.crossfit != 0 ? `<div class="col">${checkmark}<br />Crossfit</div>` : '';
        const hiit = gym?.hiit != 0 ? `<div class="col">${checkmark}<br />HIIT</div>` : '';
        const spin = gym?.spin != 0 ? `<div class="col">${checkmark}<br />Spin</div>` : '';
        const swim = gym?.swim != 0 ? `<div class="col">${checkmark}<br />Swim</div>` : '';
        const zumba = gym?.zumba != 0 ? `<div class="col">${checkmark}<br />Zumba</div>` : '';

        // Amenities
        const openGym = gym?.opengym != 0 ? `<div class="col">${checkmark}<br />Open Gym</div>` : '';
        const personalTraining = gym?.personaltraining != 0 ? `<div class="col">${checkmark}<br />Personal Training</div>` : '';
        const nutrition = gym?.nutrition != 0 ? `<div class="col">${checkmark}<br />Nutrition</div>` : '';
        const pool = gym?.pool != 0 ? `<div class="col">${checkmark}<br />Pool</div>` : '';
        const shower = gym?.shower != 0 ? `<div class="col">${checkmark}<br />Shower</div>` : '';
        const locallyOwned = gym?.locallyowned != 0 ? `<div class="col">${checkmark}<br />Locally Owned</div>` : '';
        const femaleOwned = gym?.femaleowned != 0 ? `<div class="col">${checkmark}<br />Female Owned</div>` : '';
        const minorityOwned = gym?.minorityowned != 0 ? `<div class="col">${checkmark}<br />Minority Owned</div>` : '';
        const parking = gym?.parking != 0 ? `<div class="col">${checkmark}<br />Parking</div>` : '';
        const climbing = gym?.climbingwall != 0 ? `<div class="col">${checkmark}<br />Climbing Wall</div>` : '';

          const contentString =`
            <div id="content">
            <div id="bodyContent">
            <h3>${gym.name}</h3>
            <p>${gym.address}</p>
            ${gymPhoneNumber}
            <p>Price: ${getPrettyPrice(gym.price)}</p>
            <div class="container">
                <div class="row">
                    ${bootcamp}
                    ${boxing}
                    ${crossfit}
                    ${hiit}
                    ${spin}
                    ${swim}
                    ${yoga}
                    ${zumba}
                </div>
                <div class="row">
                    ${openGym}
                    ${personalTraining}
                    ${nutrition}
                    ${pool}
                    ${shower}
                    ${locallyOwned}
                    ${femaleOwned}
                    ${minorityOwned}
                    ${parking}
                    ${climbing}
                </div>
            </div>
            ${detailsLink}  
            </div>
            </div>
            `;
  
          const infowindow = new google.maps.InfoWindow({
            content: contentString,
          });

          // Red Marker
          const marker = new google.maps.Marker({
            position: getCoords(gym),
            map: map,
          });

          // Blue Marker
        //   https://medium.com/free-code-camp/how-to-change-javascript-google-map-marker-color-8a72131d1207
        //   const marker = new google.maps.Marker({
        //     position: gym.coords,
        //     map: map,
        //     icon: {
        //     url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
        //     },
        //   });
  
          marker.addListener("click", () => {
              console.log(gym);
            infowindow.open(map, marker);
          });
  
          markers.push(marker);
        }
  
        // Removes the markers from the map, but keeps them in the array.
        function clearMarkers() {
          setMapOnAll(null);
        }
  
        // Deletes all markers in the array by removing references to them.
        function deleteMarkers() {
          clearMarkers();
          markers = [];
        }

        function getGymsFromApi(sw, ne) {
            var xhr = new XMLHttpRequest();
            var gyms_api = `http://barbellfinder.com/api/gym/read_within_bounds.php?latLower=${sw.lat()}&latUpper=${ne.lat()}&lngLower=${sw.lng()}&lngUpper=${ne.lng()}`;

            xhr.open('GET', gyms_api, true);
            xhr.send();
            xhr.onreadystatechange = function () {
                if (xhr.readyState != 4) {
                    return;
                }
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    let shownMarkers = 0;
            
                    apiGyms = response.records;
                    apiGyms.forEach(
                        (gym) => {
                            if (hasAmenities(gym) && hasClasses(gym)) {
                                // console.log('Has Amenities', hasAmenities(gym));
                                shownMarkers++;
                                addMarker(gym);
                            }
                        }
                    )

                    if (shownMarkers > 0) {
                        document.querySelector('#side #gymsShown').innerHTML = `${shownMarkers} gyms shown`;
                    } else {
                        document.querySelector('#side #gymsShown').innerHTML = `No gyms shown`;
                    }
                    
                } else {
                    console.error(xhr.statusText);
                }
            }
        } 
        
        // Utils
        function getPrettyPrice(price) {
            switch (price) {
                case 0:
                    return 'None Given';
                    break;
                case 1:
                    return 'Less than $30/month';
                    break;
                case 2:
                    return 'Less than $60/month';
                    break;
                case 3:
                    return 'Less than $90/month';
                    break;
                case 4:
                    return 'Less than $120/month';
                    break;
                case 5:
                    return 'More than $120/month';
                    break;
                default:
                    return 'None Given';
                    break;
            }
        }

        function getCoords(gym) {
            return {lat: parseFloat(gym.lat),lng: parseFloat(gym.lng)};
        }
        
      </script>
      <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  </body>
</html>