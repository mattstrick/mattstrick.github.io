<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBWUIVQ6XyFm2qpZwJD1OY2rdJ1BOKw9lE&callback=&libraries=&v=weekly"
    ></script>
</head>
<body>
    <div>
        <h3>Create Gym</h3>
        <div><label for="name">Name</label><input type="text" name="name" id="name"></div>
        <div><label for="address">Address</label><input type="text" name="address" id="address"></div>
        <div><label for="phone">Phone</label><input type="text" name="phone" id="phone"></div>
        <div><label for="price">Price</label>
            <select name="price" id="price">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            </select>
        </div>
        <div><label for="classes_id">Classes ID</label><input type="text" name="classes_id" id="classes_id"></div>
        <div><label for="amenities_id">Amenities ID</label><input type="text" name="amenities_id" id="amenities_id"></div>
        <button id="submitGym" type="submit">Create Gym</button>
    </div>
    <div>
        <h3>Create Classes</h3>
        <div><label for="bootcamp">bootcamp</label>
            <select name="bootcamp" id="bootcamp">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <div><label for="boxing">boxing</label>
            <select name="boxing" id="boxing">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <div><label for="crossfit">crossfit</label>
            <select name="crossfit" id="crossfit">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <div><label for="hiit">hiit</label>
            <select name="hiit" id="hiit">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <div><label for="spin">spin</label>
            <select name="spin" id="spin">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <div><label for="swim">swim</label>
            <select name="swim" id="swim">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <div><label for="yoga">yoga</label>
            <select name="yoga" id="yoga">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <div><label for="zumba">zumba</label>
            <select name="zumba" id="zumba">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <button id="submitClasses" type="submit">Create Classes</button>
    </div>
    <div>
        <h3>Create Amenities</h3>
        <div><label for="opengym">opengym</label>
            <select name="opengym" id="opengym">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <div><label for="pool">pool</label>
            <select name="pool" id="pool">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <div><label for="shower">shower</label>
            <select name="shower" id="shower">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <div><label for="locallyowned">locallyowned</label>
            <select name="locallyowned" id="locallyowned">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <div><label for="femaleowned">femaleowned</label>
            <select name="femaleowned" id="femaleowned">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <div><label for="minorityowned">minorityowned</label>
            <select name="minorityowned" id="minorityowned">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <div><label for="parking">parking</label>
            <select name="parking" id="parking">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <div><label for="nutrition">nutrition</label>
            <select name="nutrition" id="nutrition">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <div><label for="personaltraining">personaltraining</label>
            <select name="personaltraining" id="personaltraining">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <div><label for="climbingwall">climbingwall</label>
            <select name="climbingwall" id="climbingwall">
            <option value="0">0</option>
            <option value="1">1</option>
            </select>
        </div>
        <button id="submitAmenities" type="submit">Create Amenities</button>
    </div>
    <script>     
        const geocoder = new google.maps.Geocoder();

        document.querySelector('#submitGym').addEventListener("click", () => {                       
            console.log('Creating new Gym listing');
            let address = document.getElementById('address').value;

            geocoder.geocode({ address: address }, (results, status) => {
                if (status === "OK") {
                    // Log out the lat long coordinate
                    console.log({"lat": results[0].geometry.location.lat(), "lng": results[0].geometry.location.lng()});
                    
                    // Check if read one returns a result, if not, create gym
                    getReadOneResultOrValidateAndSubmitGym(results[0].geometry.location.lat(), results[0].geometry.location.lng())
                } else {
                alert(
                    "Geocode was not successful for the following reason: " + status
                );
                }
            });
        });

        document.querySelector('#submitClasses').addEventListener("click", () => {                                   
            console.log('Creating new Classes listing');
            validateAndSubmitClasses();
        });

        document.querySelector('#submitAmenities').addEventListener("click", () => {                                   
            console.log('Creating new Amenities listing');
            validateAndSubmitAmenities();
        });

        function getReadOneResultOrValidateAndSubmitGym(lat,lng) {
            var xhr = new XMLHttpRequest();
            var gyms_api = `http://www.barbellfinder.com/api/gym/read_one.php?lat=${lat.toFixed(8)}&lng=${lng.toFixed(8)}`;

            xhr.open('GET', gyms_api, true);
            xhr.send();
            xhr.onreadystatechange = function () {
                if (xhr.readyState != 4) {
                    return;
                }
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    console.log('Got Gym', response);
                    
                    // Already have a gym with this lat/lng
                } else {
                    // console.error(xhr.statusText);
                    
                    // Dont have a gym, so add one
                    validateAndSubmitGym(lat, lng);
                }
            }
        }

        function validateAndSubmitAmenities() {
            const data = {
                opengym: document.querySelector('#opengym').value, 
                pool: document.querySelector('#pool').value, 
                shower: document.querySelector('#shower').value, 
                locallyowned: document.querySelector('#locallyowned').value,
                femaleowned: document.querySelector('#femaleowned').value,
                minorityowned: document.querySelector('#minorityowned').value,
                parking: document.querySelector('#parking').value,
                nutrition: document.querySelector('#nutrition').value,
                personaltraining: document.querySelector('#personaltraining').value, 
                climbingwall: document.querySelector('#climbingwall').value, 
            };

            console.log('Data', data);
            createAmenities(data);
        }

        function createAmenities(data) {
            var api = `http://barbellfinder.com/api/gym/create_amenities.php`;   
            fetch(api, {
                method: 'post',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data),
                mode: 'same-origin'
            })
            .then(function (data) {
                console.log('Request succeeded with JSON response', data);
                console.log('Fetching last amenities row');
                getLastRowFromApi(`http://barbellfinder.com/api/gym/read_last_amenities_row.php`, 'amenities');        
            })
            .catch(function (error) {
                console.log('Request failed', error);
            });
        }

        function validateAndSubmitClasses() {
            const data = {
                bootcamp: document.querySelector('#bootcamp').value, 
                boxing: document.querySelector('#boxing').value, 
                crossfit: document.querySelector('#crossfit').value, 
                hiit: document.querySelector('#hiit').value,
                spin: document.querySelector('#spin').value,
                swim: document.querySelector('#swim').value,
                yoga: document.querySelector('#yoga').value, 
                zumba: document.querySelector('#zumba').value, 
            };

            console.log('Data', data);
            createClasses(data);
        }

        function createClasses(data) {
            var api = `http://barbellfinder.com/api/gym/create_classes.php`;   
          
            fetch(api, {
                method: 'post',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data),
                mode: 'same-origin'
            })
            .then(function (data) {
                console.log('Request succeeded with JSON response', data);
                console.log('Fetching last classes row');
                getLastRowFromApi(`http://barbellfinder.com/api/gym/read_last_classes_row.php`, 'classes'); 
                // getLastRowFromApi(`http://barbellfinder.com/api/gym/read_last_amenities_row.php`, 'amenities');        
            })
            .catch(function (error) {
                console.log('Request failed', error);
            });
        }

        function getLastRowFromApi(api, type) {
            var xhr = new XMLHttpRequest();

            xhr.open('GET', api, true);
            xhr.send();
            xhr.onreadystatechange = function () {
                if (xhr.readyState != 4) {
                    return;
                }
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    console.log('Got ID', response.id); 
                    document.querySelector(`#${type}_id`).value = response.id;                           
                } else {
                    console.error(xhr.statusText);
                }
            }
        }

        function validateAndSubmitGym(lat, lng) {
            const data = {
                name:document.querySelector('#name').value, 
                lat: lat,
                lng: lng,
                address: document.querySelector('#address').value,
                phone: document.querySelector('#phone').value,
                price: document.querySelector('#price').value,
                classes_id: document.querySelector('#classes_id').value,
                amenities_id: document.querySelector('#amenities_id').value,
            }

            console.log('Data', data);

            var gyms_api = `http://barbellfinder.com/api/gym/create.php`;

            fetch(gyms_api, {
                method: 'post',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data),
                mode: 'same-origin'
            })
            .then(function (data) {
                console.log('Request succeeded with JSON response', data);
            })
            .catch(function (error) {
                console.log('Request failed', error);
            });
        }
    </script>
</body>
</html>